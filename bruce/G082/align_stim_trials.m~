clear all
cd ~/Data/bruce/G082/
load jbeG082Expts.mat
cd stims/
load ./stim_data.mat

%%
cd ~/Data/bruce/G082/stims/

n_expts = length(Expts);
expt_binoc = nan(n_expts,1);
expt_npix = nan(n_expts,1);
expt_ntrials = nan(n_expts,1);
for ii = 1:n_expts
    fprintf('Aligning expt %d of %d\n',ii,n_expts);
    cur_trial_ids = [Expts{ii}.Trials(:).id];
    
    n_trials = length(cur_trial_ids);
    stim_index = nan(n_trials,1);
    left_stim_mats = cell(n_trials,1);
    right_stim_mats = cell(n_trials,1);
    stim_nframes = nan(n_trials,1);
    stim_binoc = nan(n_trials,1);
    for jj = 1:n_trials
        match = find(trial_trial_ids == cur_trial_ids(jj));
        if ~isempty(match)
            stim_index(jj) = match;
            cur_file_id = trial_file_ids(match);
            cur_frame_set = find(frame_file_ids == cur_file_id);
            cur_frame_inds = find(frame_trial_nums(cur_frame_set) == cur_trial_ids(jj));
            
            cur_left_pix = all_left_pix{cur_file_id}(cur_frame_inds,:);
            cur_right_pix = all_right_pix{cur_file_id}(cur_frame_inds,:);
            
            left_stim_mats{jj} = cur_left_pix;
            right_stim_mats{jj} = cur_right_pix;
            if all(cur_left_pix(:) == cur_right_pix(:))
                stim_binoc(jj) = 0;
            else
                stim_binoc(jj) = 1;
            end
            
            stim_nframes(jj) = length(cur_frame_inds);
        else
            fprintf('NO MATCH FOUND FOR THIS TRIAL!\n');
        end
    end
    
    expt_binoc(ii) = max(stim_binoc);
    expt_npix(ii) = size(cur_left_pix,2);
    expt_ntrials(ii) = n_trials;
%%

sname = sprintf('Expt%d_stim',ii);
save(sname,'stim_nframes','stim_binoc','left_stim_mats','right_stim_mats');

end

%%
save expt_data expt*